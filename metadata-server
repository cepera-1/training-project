#cloud-config
ssh_pwauth: no
users:
- name: serg
  sudo: 'ALL=(ALL) NOPASSWD:ALL'
  shell: /bin/bash
  ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPE5WI3j2DjmKuwa9TUeWKcoslSUR+tu3Mv9rTR4N61U serg@ubunta
write_files:
  - path: "/home/serg/init-vpn"
    permissions: "700"
    content: |
      #!/bin/bash
      
      sudo apt update
      mkdir -p /home/serg/easyrsa
      sudo apt install openvpn -y &>/dev/null
      sudo apt install easy-rsa -y &>/dev/null
      ln -s /usr/share/easy-rsa/* /home/serg/easyrsa/
      cd /home/serg/easyrsa
      ./easyrsa init-pki &>/dev/null
      grep EASYRSA_DN vars.example | sed 's/^#//' > vars
      grep EASYRSA_ALGO vars.example | sed 's/#\?\(set_var EASYRSA_ALGO\s\).*$/\1"ec"/' >> vars
      grep EASYRSA_DIGEST vars.example | sed 's/#\?\(set_var EASYRSA_DIGEST\s\).*$/\1"sha512"/' >> vars
      sudo chown -R serg:serg /home/serg/easyrsa/*
      openvpn --genkey secret ta.key
      cp ta.key /etc/openvpn/server
      cp ta.key ~/.
      
    defer: true
runcmd:
  - ["/home/serg/init-vpn"] 
